<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Timer</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Theme colour (browser chrome / status bar) — updated by applyTheme() -->
  <meta name="theme-color" content="#1a120b" />

  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Game Timer" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

  <link rel="icon" type="image/svg+xml" href="icons/icon.svg" />
  <link id="theme-font-link" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    /* ── Theme tokens (Minecraft defaults) ──────────────────────────────── */
    :root {
      --font-family:           'Press Start 2P', monospace;

      /* Body */
      --body-base:             #1a120b;
      --body-gradient:         linear-gradient(135deg, #2d4a1e 0%, #1a2e0f 30%, #3b2a1a 60%, #1a120b 100%);
      --grid-color:            rgba(0,0,0,0.25);

      /* Header */
      --header-bg:             linear-gradient(180deg, #2a1a0a 0%, #1a120b 100%);
      --header-border:         #5a3e1b;
      --header-shadow-inner:   #8B6914;

      /* Title */
      --title-color:           #f0c040;
      --title-shadow:          #7a5200;

      /* Header buttons (settings cog, add +) */
      --hdr-btn-bg:            #5a3e1b;
      --hdr-btn-color:         #f0c040;
      --hdr-btn-shadow:        #2a1a00;
      --hdr-btn-add-bg:        #5d8c3d;
      --hdr-btn-add-shadow:    #2d4a1e;

      /* Close (X) button */
      --close-bg:              #5a2020;
      --close-color:           #ff9d9d;
      --close-shadow:          #2a0a0a;

      /* Inputs (name edit, time edit, announcement) */
      --input-bg:              #000;
      --input-color:           #f0c040;
      --input-border:          #f0c040;
      --input-shadow-a:        #7a5200;
      --input-shadow-b:        #2a2000;

      /* Timer control buttons */
      --btn-start-bg:          #5d8c3d;
      --btn-start-shadow:      #2d4a1e;
      --btn-pause-bg:          #8B6914;
      --btn-pause-shadow:      #4a3800;
      --btn-reset-bg:          #5a3e1b;
      --btn-reset-shadow:      #2a1a00;
      --btn-reset-color:       #ccc;

      /* Remove button */
      --btn-remove-bg:         #8c2020;
      --btn-remove-shadow:     #4a0a0a;
      --btn-remove-color:      #ffb0b0;

      /* Modals */
      --modal-bg:              linear-gradient(180deg, #2a1a0a 0%, #1a120b 100%);
      --modal-border:          #8B6914;
      --modal-text:            #f0c040;

      /* Circle track state overrides */
      --low-stroke:            #f0c040;
      --critical-stroke:       #e05050;
      --expired-stroke:        #ff4444;

      /* Effect tokens (overridden per theme) */
      --panel-border-radius:   0;
      --button-border-radius:  0;
      --title-text-shadow:     3px 3px 0 var(--title-shadow), -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
      --circle-drop-shadow:    drop-shadow(0 0 10px rgba(0,0,0,0.8));
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--body-base);
      background-image: var(--body-image);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ─────────────────────────────────────────────── */
    header {
      display: flex;
      align-items: center;
      padding: 14px 14px 10px;
      background: var(--header-bg);
      border-bottom: 4px solid var(--header-border);
      box-shadow: 0 4px 0 #000, inset 0 -4px 0 var(--header-shadow-inner);
      flex-shrink: 0;
      position: relative;
    }

    header h1 {
      flex: 1;
      text-align: center;
      color: var(--title-color);
      font-size: clamp(12px, 2.6vw, 26px);
      text-shadow: var(--title-text-shadow);
      letter-spacing: 2px;
      image-rendering: pixelated;
    }

    .add-timer-btn {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-family: var(--font-family);
      font-size: clamp(14px, 2vw, 20px);
      line-height: 1;
      padding: 6px 14px 8px;
      background: var(--hdr-btn-add-bg);
      color: #fff;
      border: none;
      cursor: pointer;
      text-shadow: 1px 1px 0 #000;
      box-shadow: 0 4px 0 var(--hdr-btn-add-shadow), inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.3);
      image-rendering: pixelated;
    }
    .add-timer-btn:hover { filter: brightness(1.2); }
    .add-timer-btn:active { transform: translateY(calc(-50% + 3px)); box-shadow: 0 1px 0 var(--hdr-btn-add-shadow), inset 0 1px 0 rgba(0,0,0,0.3); }

    /* ── Timers container: flex wrap tiling ──────────────────── */
    .timers-container {
      display: flex;
      flex-wrap: wrap;
      flex: 1;
      overflow-x: hidden;
      overflow-y: auto;
      align-content: stretch;
      min-height: 0;
    }

    /* Each panel fills equally; min-width means they wrap below ~280px */
    .timer-panel {
      flex: 1 1 280px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      gap: 16px;
      position: relative;
      border: 2px solid #000;
      min-height: 340px;
      border-radius: var(--panel-border-radius);
    }

    /* Default accent backgrounds (overridden by applyTheme inline styles) */
    .timer-panel[data-accent="0"] { background: linear-gradient(135deg, #1e3a1e 0%, #0f2010 100%); }
    .timer-panel[data-accent="1"] { background: linear-gradient(135deg, #1a1a3a 0%, #0f0f20 100%); }
    .timer-panel[data-accent="2"] { background: linear-gradient(135deg, #3a1a1a 0%, #200f0f 100%); }
    .timer-panel[data-accent="3"] { background: linear-gradient(135deg, #2a1a3a 0%, #160f20 100%); }
    .timer-panel[data-accent="4"] { background: linear-gradient(135deg, #1a2a3a 0%, #0f1420 100%); }
    .timer-panel[data-accent="5"] { background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0f 100%); }

    /* Default stroke colors per accent (overridden by applyTheme inline styles) */
    .timer-panel[data-accent="0"] .circle-track { stroke: #5dbc5d; }
    .timer-panel[data-accent="1"] .circle-track { stroke: #5d8cbc; }
    .timer-panel[data-accent="2"] .circle-track { stroke: #bc5d5d; }
    .timer-panel[data-accent="3"] .circle-track { stroke: #a05dbc; }
    .timer-panel[data-accent="4"] .circle-track { stroke: #5d9abc; }
    .timer-panel[data-accent="5"] .circle-track { stroke: #bcb05d; }

    /* Default name label colors per accent (overridden by applyTheme inline styles) */
    .timer-panel[data-accent="0"] .player-name { color: #7dff7d; border-color: #3d8c3d; background: #1a3a1a; box-shadow: 3px 3px 0 #000, inset -2px -2px 0 #1a3a1a, inset 2px 2px 0 #3d8c3d; }
    .timer-panel[data-accent="1"] .player-name { color: #7db3ff; border-color: #3d5a8c; background: #1a1a3a; box-shadow: 3px 3px 0 #000, inset -2px -2px 0 #1a1a3a, inset 2px 2px 0 #3d5a8c; }
    .timer-panel[data-accent="2"] .player-name { color: #ff9d9d; border-color: #8c3d3d; background: #3a1a1a; box-shadow: 3px 3px 0 #000, inset -2px -2px 0 #3a1a1a, inset 2px 2px 0 #8c3d3d; }
    .timer-panel[data-accent="3"] .player-name { color: #d49dff; border-color: #6a3d8c; background: #2a1a3a; box-shadow: 3px 3px 0 #000, inset -2px -2px 0 #2a1a3a, inset 2px 2px 0 #6a3d8c; }
    .timer-panel[data-accent="4"] .player-name { color: #9dd4ff; border-color: #3d6a8c; background: #1a2a3a; box-shadow: 3px 3px 0 #000, inset -2px -2px 0 #1a2a3a, inset 2px 2px 0 #3d6a8c; }
    .timer-panel[data-accent="5"] .player-name { color: #ffe07d; border-color: #8c7a3d; background: #2a2a1a; box-shadow: 3px 3px 0 #000, inset -2px -2px 0 #2a2a1a, inset 2px 2px 0 #8c7a3d; }

    /* ── Expired: flash (default) ────────────────────────────── */
    .timer-panel.expired {
      animation: flashExpired 0.5s steps(1) infinite;
      box-shadow: 0 0 60px #ff0000, inset 0 0 40px rgba(255,0,0,0.3) !important;
    }
    @keyframes flashExpired {
      0%, 100% { background: linear-gradient(135deg, #ff1a1a 0%, #aa0000 100%) !important; }
      50%       { background: linear-gradient(135deg, #550000 0%, #1a0000 100%) !important; }
    }
    /* Flat red after 30 s of flashing */
    .timer-panel.expired.expired-flat {
      animation: none;
      background: linear-gradient(135deg, #ff1a1a 0%, #aa0000 100%) !important;
    }

    /* ── Expired: pulse (soft, kid-friendly) ─────────────────── */
    .timer-panel.expired[data-expired-style="pulse"] {
      animation: pulseExpired 1.2s ease-in-out infinite;
      box-shadow: 0 0 40px rgba(255,80,80,0.7), inset 0 0 30px rgba(255,80,80,0.2) !important;
    }
    @keyframes pulseExpired {
      0%, 100% { background: linear-gradient(135deg, #cc2222 0%, #880000 100%) !important; }
      50%       { background: linear-gradient(135deg, #ff6666 0%, #cc2222 100%) !important; }
    }
    .timer-panel.expired.expired-flat[data-expired-style="pulse"] {
      animation: none;
      background: linear-gradient(135deg, #cc2222 0%, #880000 100%) !important;
    }

    /* ── Expired: solid (no animation, instant) ──────────────── */
    .timer-panel.expired[data-expired-style="solid"] {
      animation: none;
      background: linear-gradient(135deg, #cc1a1a 0%, #880000 100%) !important;
      box-shadow: 0 0 30px rgba(200,0,0,0.5), inset 0 0 20px rgba(200,0,0,0.2) !important;
    }
    .timer-panel.expired.expired-flat[data-expired-style="solid"] {
      animation: none;
      background: linear-gradient(135deg, #cc1a1a 0%, #880000 100%) !important;
    }

    /* ── Close (X) button ────────────────────────────────────── */
    .close-timer-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      font-family: var(--font-family);
      font-size: 11px;
      padding: 4px 8px;
      background: var(--close-bg);
      color: var(--close-color);
      border: none;
      cursor: pointer;
      border-radius: var(--button-border-radius);
      box-shadow: 0 3px 0 var(--close-shadow), inset 0 1px 0 rgba(255,255,255,0.15);
      text-shadow: 1px 1px 0 #000;
      z-index: 5;
    }
    .close-timer-btn:hover { filter: brightness(1.3); }
    .close-timer-btn:active { transform: translateY(2px); box-shadow: none; }
    .close-timer-btn.hidden { display: none; }

    /* ── Player name ─────────────────────────────────────────── */
    .name-area { flex-shrink: 0; }

    .player-name {
      font-size: clamp(11px, 2vw, 20px);
      letter-spacing: 3px;
      text-shadow: 2px 2px 0 #000;
      padding: 8px 16px;
      border: 3px solid;
      image-rendering: pixelated;
      cursor: pointer;
    }
    .player-name:hover { filter: brightness(1.3); }

    /* Name edit input */
    .name-edit-wrapper {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .name-edit-wrapper.visible { display: flex; }
    .name-edit-wrapper label {
      font-size: clamp(7px, 1vw, 9px);
      color: rgba(255,255,255,0.6);
    }
    .name-edit-input {
      font-family: var(--font-family);
      font-size: clamp(11px, 1.8vw, 16px);
      background: var(--input-bg);
      color: var(--input-color);
      border: 3px solid var(--input-border);
      padding: 6px 10px;
      width: 160px;
      text-align: center;
      outline: none;
      border-radius: var(--button-border-radius);
      box-shadow: 3px 3px 0 var(--input-shadow-a), inset 2px 2px 0 var(--input-shadow-b);
      image-rendering: pixelated;
      letter-spacing: 2px;
    }
    .name-edit-input:focus { border-color: #fff; box-shadow: 3px 3px 0 #555, inset 2px 2px 0 #222; }

    /* ── SVG Circle Timer ────────────────────────────────────── */
    .circle-wrapper {
      flex-shrink: 0;
      position: relative;
      cursor: pointer;
    }
    .circle-wrapper:hover .time-display {
      text-shadow: 0 0 12px currentColor, 2px 2px 0 #000;
    }
    .circle-wrapper svg {
      display: block;
      filter: var(--circle-drop-shadow);
    }
    .circle-bg {
      fill: none;
      stroke: rgba(0,0,0,0.5);
      stroke-width: 14;
    }
    .circle-track {
      fill: none;
      stroke-width: 14;
      stroke-linecap: square;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dashoffset 0.9s linear, stroke 0.5s;
    }
    .circle-track.low      { stroke: var(--low-stroke)      !important; }
    .circle-track.critical { stroke: var(--critical-stroke) !important; }
    .circle-track.expired  { stroke: var(--expired-stroke)  !important; }

    .time-display-group {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 100%;
    }
    .time-display {
      font-size: clamp(15px, 5vmin, 80px);
      color: #fff;
      text-shadow: 2px 2px 0 #000;
      cursor: pointer;
      display: block;
      line-height: 1;
      padding: 6px 0;
      letter-spacing: 2px;
      image-rendering: pixelated;
    }
    .edit-hint {
      font-size: clamp(6px, 1.2vmin, 12px);
      color: rgba(255,255,255,0.4);
      margin-top: 5px;
      display: block;
    }

    /* Time edit input */
    .edit-input-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      width: 80%;
    }
    .edit-input-wrapper.visible { display: flex; }
    .edit-input-wrapper label { font-size: clamp(7px, 1vw, 10px); color: rgba(255,255,255,0.6); }
    .edit-input {
      font-family: var(--font-family);
      font-size: clamp(14px, 2.5vw, 22px);
      background: var(--input-bg);
      color: var(--input-color);
      border: 3px solid var(--input-border);
      padding: 8px 12px;
      width: 100%;
      text-align: center;
      outline: none;
      border-radius: var(--button-border-radius);
      box-shadow: 3px 3px 0 var(--input-shadow-a), inset 2px 2px 0 var(--input-shadow-b);
      image-rendering: pixelated;
    }
    .edit-input:focus { border-color: #fff; box-shadow: 3px 3px 0 #555, inset 2px 2px 0 #222; }

    /* ── Buttons ─────────────────────────────────────────────── */
    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; flex-shrink: 0; }

    .mc-btn {
      font-family: var(--font-family);
      font-size: clamp(7px, 1.1vw, 11px);
      padding: clamp(7px, 1vw, 10px) clamp(8px, 1.4vw, 14px);
      border: none;
      cursor: pointer;
      image-rendering: pixelated;
      letter-spacing: 1px;
      border-radius: var(--button-border-radius);
      transition: filter 0.1s;
      position: relative;
      top: 0;
    }
    .mc-btn:active { top: 3px; }

    .mc-btn.start-btn {
      background: var(--btn-start-bg);
      color: #fff;
      box-shadow: 0 4px 0 var(--btn-start-shadow), inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.3);
      text-shadow: 1px 1px 0 #000;
    }
    .mc-btn.start-btn:hover  { filter: brightness(1.2); }
    .mc-btn.start-btn:active { box-shadow: 0 1px 0 var(--btn-start-shadow), inset 0 1px 0 rgba(0,0,0,0.3); }

    .mc-btn.pause-btn {
      background: var(--btn-pause-bg);
      color: #fff;
      box-shadow: 0 4px 0 var(--btn-pause-shadow), inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.3);
      text-shadow: 1px 1px 0 #000;
    }
    .mc-btn.pause-btn:hover  { filter: brightness(1.2); }
    .mc-btn.pause-btn:active { box-shadow: 0 1px 0 var(--btn-pause-shadow), inset 0 1px 0 rgba(0,0,0,0.3); }

    .mc-btn.reset-btn {
      background: var(--btn-reset-bg);
      color: var(--btn-reset-color);
      box-shadow: 0 4px 0 var(--btn-reset-shadow), inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.3);
      text-shadow: 1px 1px 0 #000;
    }
    .mc-btn.reset-btn:hover  { filter: brightness(1.2); }
    .mc-btn.reset-btn:active { box-shadow: 0 1px 0 var(--btn-reset-shadow), inset 0 1px 0 rgba(0,0,0,0.3); }

    /* ── Expired message ─────────────────────────────────────── */
    .expired-msg {
      flex-shrink: 0;
      font-size: clamp(9px, 1.2vw, 12px);
      color: #fff;
      text-shadow: 2px 2px 0 #000, 0 0 10px #ff0000;
      display: none;
      text-align: center;
      line-height: 1.8;
      animation: blink 0.5s steps(1) infinite;
    }
    .expired-msg.visible { display: block; }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0; }
    }

    /* ── Confirmation modal ───────────────────────────────────── */
    #confirm-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    #confirm-overlay.visible { display: flex; }

    #confirm-box {
      background: var(--modal-bg);
      border: 4px solid var(--modal-border);
      box-shadow: 0 0 0 4px #000, 6px 6px 0 #000;
      padding: 32px 28px 24px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 22px;
    }

    #confirm-box p {
      font-size: clamp(9px, 1.5vw, 13px);
      color: var(--modal-text);
      text-shadow: 2px 2px 0 #000;
      line-height: 1.9;
    }

    #confirm-box p span#confirm-name {
      color: #fff;
    }

    #confirm-btns {
      display: flex;
      gap: 16px;
    }

    .mc-btn.cancel-btn {
      background: var(--btn-reset-bg);
      color: var(--btn-reset-color);
      box-shadow: 0 4px 0 var(--btn-reset-shadow), inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.3);
      text-shadow: 1px 1px 0 #000;
    }
    .mc-btn.cancel-btn:hover  { filter: brightness(1.2); }
    .mc-btn.cancel-btn:active { box-shadow: 0 1px 0 var(--btn-reset-shadow); top: 3px; }

    .mc-btn.remove-btn {
      background: var(--btn-remove-bg);
      color: var(--btn-remove-color);
      box-shadow: 0 4px 0 var(--btn-remove-shadow), inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.3);
      text-shadow: 1px 1px 0 #000;
    }
    .mc-btn.remove-btn:hover  { filter: brightness(1.2); }
    .mc-btn.remove-btn:active { box-shadow: 0 1px 0 var(--btn-remove-shadow); top: 3px; }

    /* ── Settings cog button ──────────────────────────────────── */
    .settings-btn {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-family: var(--font-family);
      font-size: clamp(14px, 2vw, 20px);
      line-height: 1;
      padding: 6px 10px 8px;
      background: var(--hdr-btn-bg);
      color: var(--hdr-btn-color);
      border: none;
      cursor: pointer;
      text-shadow: 1px 1px 0 #000;
      box-shadow: 0 4px 0 var(--hdr-btn-shadow), inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.3);
      image-rendering: pixelated;
    }
    .settings-btn:hover { filter: brightness(1.2); }
    .settings-btn:active { transform: translateY(calc(-50% + 3px)); box-shadow: 0 1px 0 var(--hdr-btn-shadow), inset 0 1px 0 rgba(0,0,0,0.3); }

    /* ── Settings modal ───────────────────────────────────────── */
    #settings-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 200;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: 16px;
    }
    #settings-overlay.visible { display: flex; }

    #settings-box {
      background: var(--modal-bg);
      border: 4px solid var(--modal-border);
      box-shadow: 0 0 0 4px #000, 6px 6px 0 #000;
      padding: 28px 24px 24px;
      max-width: 560px;
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin: auto;
    }

    #settings-box h2 {
      font-size: clamp(9px, 1.5vw, 13px);
      color: var(--modal-text);
      text-shadow: 2px 2px 0 #000;
      letter-spacing: 2px;
    }

    #settings-box label {
      font-size: clamp(7px, 1vw, 9px);
      color: rgba(255,255,255,0.6);
      display: block;
      margin-bottom: 8px;
      text-align: left;
      width: 100%;
    }

    #settings-hint {
      font-size: clamp(6px, 0.8vw, 8px);
      color: rgba(255,255,255,0.4);
      text-align: left;
      width: 100%;
      line-height: 1.6;
    }

    /* ── Theme picker ─────────────────────────────────────────── */
    #theme-section {
      width: 100%;
    }

    #theme-picker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      width: 100%;
    }

    .theme-btn {
      font-family: var(--font-family);
      font-size: clamp(5px, 0.9vw, 8px);
      padding: 10px 6px;
      border: 3px solid transparent;
      cursor: pointer;
      text-align: center;
      line-height: 1.5;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 0 #000;
      box-shadow: 0 3px 0 rgba(0,0,0,0.6);
      transition: filter 0.1s, transform 0.1s;
      word-break: break-word;
      image-rendering: pixelated;
      position: relative;
      border-radius: 4px;
    }
    .theme-btn:hover { filter: brightness(1.25); }
    .theme-btn:active { transform: translateY(2px); box-shadow: none; }
    .theme-btn.selected {
      box-shadow: 0 0 0 3px #fff, 0 0 0 5px #000, 0 3px 0 rgba(0,0,0,0.6);
      filter: brightness(1.15);
    }

    /* ── Announcement section ─────────────────────────────────── */
    #announcement-section {
      width: 100%;
    }

    #announcement-input {
      font-family: var(--font-family);
      font-size: clamp(7px, 1vw, 9px);
      background: var(--input-bg);
      color: var(--input-color);
      border: 3px solid var(--input-border);
      padding: 10px 12px;
      width: 100%;
      outline: none;
      border-radius: var(--button-border-radius);
      box-shadow: 3px 3px 0 var(--input-shadow-a), inset 2px 2px 0 var(--input-shadow-b);
      image-rendering: pixelated;
      letter-spacing: 1px;
      resize: vertical;
      min-height: 80px;
      line-height: 1.8;
    }
    #announcement-input:focus { border-color: #fff; box-shadow: 3px 3px 0 #555, inset 2px 2px 0 #222; }

    #settings-btns { display: flex; gap: 16px; }

    .mc-btn.save-btn {
      background: var(--btn-start-bg);
      color: #fff;
      box-shadow: 0 4px 0 var(--btn-start-shadow), inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.3);
      text-shadow: 1px 1px 0 #000;
    }
    .mc-btn.save-btn:hover  { filter: brightness(1.2); }
    .mc-btn.save-btn:active { box-shadow: 0 1px 0 var(--btn-start-shadow); top: 3px; }

    /* ── Mobile responsive fixes ─────────────────────────────── */
    @media (max-width: 600px) {
      header {
        padding: 16px 16px 16px;
        min-height: 64px;
      }

      header h1 {
        font-size: clamp(14px, 4vw, 20px);
      }

      .settings-btn,
      .add-timer-btn {
        font-size: clamp(14px, 3.5vw, 18px);
        padding: 8px 12px 10px;
      }

      .timer-panel {
        padding: 20px 20px 28px;
      }

      #theme-picker-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <button class="settings-btn" id="settings-btn" title="Settings">&#9881;</button>
    <h1 id="app-title">&#9733; MINECRAFT TIMER &#9733;</h1>
    <button class="add-timer-btn" id="add-timer-btn" title="Add new timer">+</button>
  </header>

  <div class="timers-container" id="timers-container"></div>

  <!-- Settings modal (hidden by default) -->
  <div id="settings-overlay" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div id="settings-box">
      <h2 id="settings-title">SETTINGS</h2>

      <!-- Theme picker -->
      <div id="theme-section">
        <label>CHOOSE THEME</label>
        <div id="theme-picker-grid">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Announcement message -->
      <div id="announcement-section">
        <label for="announcement-input">ANNOUNCEMENT MESSAGE</label>
        <textarea id="announcement-input" rows="3"></textarea>
        <p id="settings-hint">Use {{name}} as a placeholder for the timer's name.</p>
      </div>

      <div id="settings-btns">
        <button class="mc-btn cancel-btn" id="settings-cancel">CANCEL</button>
        <button class="mc-btn save-btn"   id="settings-save">SAVE</button>
      </div>
    </div>
  </div>

  <!-- Confirmation modal (hidden by default) -->
  <div id="confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="confirm-text">
    <div id="confirm-box">
      <p id="confirm-text">Remove timer<br><span id="confirm-name"></span>?</p>
      <div id="confirm-btns">
        <button class="mc-btn cancel-btn" id="confirm-cancel">CANCEL</button>
        <button class="mc-btn remove-btn" id="confirm-remove">REMOVE</button>
      </div>
    </div>
  </div>

  <!-- Themes data (must load before main script) -->
  <script src="themes.js"></script>

  <script>
    (function () {
      var CIRCUMFERENCE = 2 * Math.PI * 96;
      var NUM_ACCENTS   = 6;

      /* ── Theme management ────────────────────────────────────── */
      var currentThemeId         = 'minecraft';
      var previewThemeId         = null; // set while settings modal is open

      function loadThemeId() {
        try {
          var raw = localStorage.getItem('mc-timer-theme');
          if (raw && THEMES.find(function (t) { return t.id === raw; })) return raw;
        } catch (e) {}
        return 'minecraft';
      }
      function saveThemeId(id) {
        try { localStorage.setItem('mc-timer-theme', id); } catch (e) {}
      }

      // Effect defaults — used when a theme omits an effects key
      var EFFECT_DEFAULTS = {
        bodyPattern:  'grid',
        panelRadius:  '0',
        buttonRadius: '0',
        titleShadow:  'blocky',
        expiredStyle: 'flash',
        circleShadow: '0 0 10px rgba(0,0,0,0.8)',
      };

      function effectVal(theme, key) {
        return (theme.effects && theme.effects[key] !== undefined)
          ? theme.effects[key]
          : EFFECT_DEFAULTS[key];
      }

      function buildBodyImage(theme) {
        var pattern = effectVal(theme, 'bodyPattern');
        var gridColor = theme.vars['--grid-color'] || 'rgba(0,0,0,0.25)';
        var gradient  = theme.vars['--body-gradient'];
        if (pattern === 'grid') {
          return (
            'repeating-linear-gradient(0deg, transparent, transparent 31px, ' + gridColor + ' 31px, ' + gridColor + ' 32px), ' +
            'repeating-linear-gradient(90deg, transparent, transparent 31px, ' + gridColor + ' 31px, ' + gridColor + ' 32px), ' +
            gradient
          );
        }
        return gradient;
      }

      function buildTitleShadow(theme) {
        var style    = effectVal(theme, 'titleShadow');
        var shadow   = theme.vars['--title-shadow'] || '#000';
        if (style === 'blocky') {
          return '3px 3px 0 ' + shadow + ', -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000';
        }
        if (style === 'soft') {
          return '0 2px 8px ' + shadow + ', 0 1px 2px rgba(0,0,0,0.8)';
        }
        if (style === 'glow') {
          return '0 0 12px ' + shadow + ', 0 0 24px ' + shadow + ', 0 2px 4px rgba(0,0,0,0.9)';
        }
        return 'none';
      }

      function applyTheme(themeId) {
        var theme = THEMES.find(function (t) { return t.id === themeId; }) || THEMES[0];
        var root  = document.documentElement;

        // Set all color/gradient CSS custom properties
        Object.keys(theme.vars).forEach(function (varName) {
          root.style.setProperty(varName, theme.vars[varName]);
        });

        // Set effect CSS custom properties
        root.style.setProperty('--panel-border-radius',  effectVal(theme, 'panelRadius'));
        root.style.setProperty('--button-border-radius', effectVal(theme, 'buttonRadius'));
        root.style.setProperty('--title-text-shadow',    buildTitleShadow(theme));
        root.style.setProperty('--circle-drop-shadow',   'drop-shadow(' + effectVal(theme, 'circleShadow') + ')');
        root.style.setProperty('--body-image',           buildBodyImage(theme));

        // Swap font
        var fontLink = document.getElementById('theme-font-link');
        if (fontLink && theme.fontUrl) {
          fontLink.href = theme.fontUrl;
        }
        if (theme.fontFamily) {
          root.style.setProperty('--font-family', theme.fontFamily);
        }

        // Apply accent inline styles to each existing panel
        applyAccentsToAllPanels(theme);

        // Update header title
        var h1 = document.getElementById('app-title');
        if (h1) h1.textContent = theme.title;

        // Update expired messages text and expired-style attribute
        var expiredStyle = effectVal(theme, 'expiredStyle');
        document.querySelectorAll('.expired-msg').forEach(function (el) {
          el.innerHTML = theme.gameName + ' time<br>is over!';
        });
        document.querySelectorAll('.timer-panel').forEach(function (panel) {
          panel.setAttribute('data-expired-style', expiredStyle);
        });

        // Update meta theme-color
        var metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) metaTheme.setAttribute('content', theme.vars['--body-base']);

        currentThemeId = themeId;
      }

      function applyAccentsToAllPanels(theme) {
        document.querySelectorAll('.timer-panel').forEach(function (panel, i) {
          applyAccentToPanel(panel, i, theme);
        });
      }

      function applyAccentToPanel(panel, accentIndex, theme) {
        var accent = theme.accents[accentIndex % theme.accents.length];
        // Panel background
        panel.style.background = accent.panelBg;
        // Circle track stroke
        var track = panel.querySelector('.circle-track');
        if (track) track.style.stroke = accent.stroke;
        // Player name label
        var nameLabel = panel.querySelector('.player-name');
        if (nameLabel) {
          nameLabel.style.color      = accent.nameColor;
          nameLabel.style.borderColor = accent.nameBorder;
          nameLabel.style.background  = accent.nameBg;
          nameLabel.style.boxShadow   = accent.nameBoxShadow;
        }
      }

      /* ── Audio ───────────────────────────────────────────────── */
      var audioCtx = null;
      function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
      }
      function playAlarm() {
        try {
          var ctx = getAudioCtx();
          [{ freq: 880, s: 0.00, d: 0.18 }, { freq: 660, s: 0.22, d: 0.18 }, { freq: 440, s: 0.44, d: 0.32 }]
            .forEach(function (b) {
              var osc = ctx.createOscillator(), g = ctx.createGain();
              osc.connect(g); g.connect(ctx.destination);
              osc.type = 'square';
              osc.frequency.setValueAtTime(b.freq, ctx.currentTime + b.s);
              g.gain.setValueAtTime(0.28, ctx.currentTime + b.s);
              g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + b.s + b.d);
              osc.start(ctx.currentTime + b.s);
              osc.stop(ctx.currentTime + b.s + b.d + 0.01);
            });
        } catch (e) {}
      }
      function speak(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        var u = new SpeechSynthesisUtterance(text);
        u.rate = 0.9; u.pitch = 0.8;
        window.speechSynthesis.speak(u);
      }

      /* ── Timer-state localStorage ────────────────────────────── */
      function saveState(id, state) {
        try { localStorage.setItem('mc-timer-' + id, JSON.stringify(state)); } catch (e) {}
      }
      function loadState(id) {
        try {
          var raw = localStorage.getItem('mc-timer-' + id);
          if (raw) { var s = JSON.parse(raw); if (s && typeof s.totalSeconds === 'number') return s; }
        } catch (e) {}
        return { totalSeconds: 0, remaining: 0, running: false, paused: false, startedAt: null };
      }

      /* ── Timer-list localStorage ─────────────────────────────── */
      function loadTimerList() {
        try {
          var raw = localStorage.getItem('mc-timer-list');
          if (raw) {
            var arr = JSON.parse(raw);
            if (Array.isArray(arr) && arr.length > 0) return arr;
          }
        } catch (e) {}
        var defaults = [{ id: 'child1', displayName: 'Child 1' }, { id: 'child2', displayName: 'Child 2' }];
        saveTimerList(defaults);
        return defaults;
      }
      function saveTimerList(list) {
        try { localStorage.setItem('mc-timer-list', JSON.stringify(list)); } catch (e) {}
      }

      var timerList   = [];  // { id, displayName }
      var timersById  = {};  // id → Timer instance

      /* ── Announcement template ───────────────────────────────── */
      var ANNOUNCEMENT_DEFAULT = '{{name}}, your minecraft time is over! Please turn off your device and give it to Daddy';
      function loadAnnouncement() {
        try {
          var raw = localStorage.getItem('mc-timer-announcement');
          if (raw && raw.trim().length > 0) return raw;
        } catch (e) {}
        return ANNOUNCEMENT_DEFAULT;
      }
      function saveAnnouncement(text) {
        try { localStorage.setItem('mc-timer-announcement', text); } catch (e) {}
      }
      var announcementTemplate = loadAnnouncement();

      /* ── Create DOM for one timer panel ─────────────────────── */
      function createTimerPanel(id, displayName) {
        var panel = document.createElement('div');
        panel.className = 'timer-panel';
        panel.id = 'panel-' + id;
        var accentIdx = timerList.findIndex(function (t) { return t.id === id; }) % NUM_ACCENTS;
        if (accentIdx < 0) accentIdx = 0;
        panel.setAttribute('data-accent', String(accentIdx));

        var theme = THEMES.find(function (t) { return t.id === currentThemeId; }) || THEMES[0];
        var expStyle = (theme.effects && theme.effects.expiredStyle) ? theme.effects.expiredStyle : 'flash';
        panel.setAttribute('data-expired-style', expStyle);

        panel.innerHTML = [
          '<button class="close-timer-btn" id="close-' + id + '" aria-label="Remove timer" title="Remove timer">&#xD7;</button>',

          // Name area
          '<div class="name-area" id="name-area-' + id + '">',
          '  <span class="player-name" id="name-label-' + id + '" title="Click to rename">' + escHtml(displayName.toUpperCase()) + '</span>',
          '  <div class="name-edit-wrapper" id="name-edit-wrapper-' + id + '">',
          '    <label>NAME</label>',
          '    <input class="name-edit-input" id="name-edit-' + id + '" type="text" maxlength="20" placeholder="Enter name" />',
          '  </div>',
          '</div>',

          // SVG circle
          '<div class="circle-wrapper" id="wrapper-' + id + '">',
          '  <svg id="svg-' + id + '" viewBox="0 0 220 220">',
          '    <circle class="circle-bg"    cx="110" cy="110" r="96" />',
          '    <circle class="circle-track" id="track-' + id + '" cx="110" cy="110" r="96" />',
          '  </svg>',
          '  <div class="time-display-group" id="display-group-' + id + '">',
          '    <span class="time-display" id="display-' + id + '" title="Click to set time">00:00</span>',
          '    <span class="edit-hint">[ click to set ]</span>',
          '  </div>',
          '  <div class="edit-input-wrapper" id="edit-wrapper-' + id + '">',
          '    <label>SET TIME</label>',
          '    <input class="edit-input" id="edit-' + id + '" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="9" placeholder="0:00" autocomplete="off" />',
          '  </div>',
          '</div>',

          // Expired message
          '<div class="expired-msg" id="expired-' + id + '">' + escHtml(theme.gameName) + ' time<br>is over!</div>',

          // Buttons
          '<div class="btn-row">',
          '  <button class="mc-btn start-btn" id="start-' + id + '">START</button>',
          '  <button class="mc-btn pause-btn" id="pause-' + id + '" disabled>PAUSE</button>',
          '  <button class="mc-btn reset-btn" id="reset-' + id + '">RESET</button>',
          '</div>',
        ].join('\n');

        return panel;
      }

      function escHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      /* ── Update X-button visibility: hide when only one timer ── */
      function refreshCloseBtns() {
        var ids = timerList.map(function (t) { return t.id; });
        ids.forEach(function (id) {
          var btn = document.getElementById('close-' + id);
          if (!btn) return;
          if (timerList.length <= 1) { btn.classList.add('hidden'); }
          else { btn.classList.remove('hidden'); }
        });
      }

      /* ── Time digit helpers (microwave-style input) ──────────── */
      function formatTimeDigits(rawDigits) {
        var d = rawDigits.replace(/\D/g, '').slice(-7);
        var padded = d.padStart(7, '0');
        var h  = parseInt(padded.slice(0, 3), 10);
        var m  = parseInt(padded.slice(3, 5), 10);
        var s  = parseInt(padded.slice(5, 7), 10);
        var ss = String(s).padStart(2, '0');
        var mm = String(m).padStart(2, '0');
        if (h > 0) return h + ':' + mm + ':' + ss;
        return mm + ':' + ss;
      }

      function parseTimeDigits(rawDigits) {
        var d = rawDigits.replace(/\D/g, '').slice(-7);
        var padded = d.padStart(7, '0');
        var h = parseInt(padded.slice(0, 3), 10);
        var m = parseInt(padded.slice(3, 5), 10);
        var s = parseInt(padded.slice(5, 7), 10);
        return h * 3600 + m * 60 + s;
      }

      function totalSecondsToDigits(totalSecs) {
        var secs = Math.max(0, Math.floor(totalSecs));
        var h = Math.floor(secs / 3600);
        var m = Math.floor((secs % 3600) / 60);
        var s = secs % 60;
        if (h > 0) return String(h) + String(m).padStart(2, '0') + String(s).padStart(2, '0');
        if (m > 0) return String(m) + String(s).padStart(2, '0');
        return String(s);
      }

      /* ── Timer class ─────────────────────────────────────────── */
      function Timer(id, displayName) {
        this.id                  = id;
        this.displayName         = displayName;
        this.expired             = false;
        this.running             = false;
        this.interval            = null;
        this.expiredFlatTimeoutId = null;

        this.panel       = document.getElementById('panel-' + id);
        this.track       = document.getElementById('track-' + id);
        this.display     = document.getElementById('display-' + id);
        this.displayGroup= document.getElementById('display-group-' + id);
        this.editWrapper = document.getElementById('edit-wrapper-' + id);
        this.editInput   = document.getElementById('edit-' + id);
        this.expiredMsg  = document.getElementById('expired-' + id);
        this.startBtn    = document.getElementById('start-' + id);
        this.pauseBtn    = document.getElementById('pause-' + id);
        this.resetBtn    = document.getElementById('reset-' + id);
        this.nameLabel   = document.getElementById('name-label-' + id);
        this.nameEditWrapper = document.getElementById('name-edit-wrapper-' + id);
        this.nameEditInput   = document.getElementById('name-edit-' + id);

        this.track.style.strokeDasharray  = CIRCUMFERENCE;
        this.track.style.strokeDashoffset = CIRCUMFERENCE;

        var state = loadState(id);
        this.totalSeconds = state.totalSeconds;
        this.remaining    = state.remaining;

        var autoExpire = false, autoResume = false;
        if (state.running && state.startedAt) {
          var elapsed      = (Date.now() - state.startedAt) / 1000;
          var newRemaining = state.remaining - elapsed;
          if (newRemaining <= 0) { this.remaining = 0; autoExpire = true; }
          else                   { this.remaining = Math.round(newRemaining); autoResume = true; }
        }

        this._bindEvents();
        this._render();

        if (autoExpire)       { this._expire(); }
        else if (autoResume)  { this._start(); }
        else if (state.paused){ this.startBtn.textContent = 'RESUME'; }
      }

      Timer.prototype._bindEvents = function () {
        var self = this;
        this.display.addEventListener('click', function () { self._openTimeEdit(); });
        this.editInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') { self._confirmTimeEdit(); return; }
          if (e.key === 'Backspace') {
            e.preventDefault();
            self._rawDigits = (self._rawDigits || '').slice(0, -1);
            self.editInput.value = formatTimeDigits(self._rawDigits);
          }
        });
        this.editInput.addEventListener('input', function () {
          var only = self.editInput.value.replace(/\D/g, '').slice(-7);
          self._rawDigits = only;
          self.editInput.value = formatTimeDigits(only);
          // Move cursor to end
          var len = self.editInput.value.length;
          self.editInput.setSelectionRange(len, len);
        });
        this.editInput.addEventListener('blur', function () { self._confirmTimeEdit(); });
        this.nameLabel.addEventListener('click', function () { self._openNameEdit(); });
        this.nameEditInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') self._confirmNameEdit(); });
        this.nameEditInput.addEventListener('blur',    function ()  { self._confirmNameEdit(); });
        this.startBtn.addEventListener('click', function () { self._start(); });
        this.pauseBtn.addEventListener('click', function () { self._pause(); });
        this.resetBtn.addEventListener('click', function () { self._reset(); });
      };

      /* ── Time edit ───────────────────────────────────────────── */
      Timer.prototype._openTimeEdit = function () {
        if (this.running) return;
        this.displayGroup.style.visibility = 'hidden';
        this.editWrapper.classList.add('visible');
        this._rawDigits = this.totalSeconds > 0 ? totalSecondsToDigits(this.totalSeconds) : '';
        this.editInput.value = formatTimeDigits(this._rawDigits);
        this.editInput.focus();
        this.editInput.select();
      };
      Timer.prototype._confirmTimeEdit = function () {
        if (!this.editWrapper.classList.contains('visible')) return;
        var secs = parseTimeDigits(this._rawDigits || '');
        if (secs >= 0) {
          this.totalSeconds = secs;
          this.remaining    = secs;
          saveState(this.id, { totalSeconds: this.totalSeconds, remaining: this.remaining, running: false, paused: false, startedAt: null });
        }
        this._rawDigits = '';
        this.editWrapper.classList.remove('visible');
        this.displayGroup.style.visibility = '';
        this._clearExpired();
        this._render();
      };

      /* ── Name edit ───────────────────────────────────────────── */
      Timer.prototype._openNameEdit = function () {
        this.nameLabel.style.display = 'none';
        this.nameEditWrapper.classList.add('visible');
        this.nameEditInput.value = this.displayName;
        this.nameEditInput.focus();
        this.nameEditInput.select();
      };
      Timer.prototype._confirmNameEdit = function () {
        var val = this.nameEditInput.value.trim();
        if (val.length > 0) {
          this.displayName = val;
          this.nameLabel.textContent = val.toUpperCase();
          var entry = timerList.find(function (t) { return t.id === this.id; }, this);
          if (entry) { entry.displayName = val; saveTimerList(timerList); }
        }
        this.nameEditWrapper.classList.remove('visible');
        this.nameLabel.style.display = '';
      };

      /* ── Timer control ───────────────────────────────────────── */
      Timer.prototype._saveRunning = function () {
        saveState(this.id, { totalSeconds: this.totalSeconds, remaining: this.remaining, running: true, paused: false, startedAt: Date.now() });
      };

      Timer.prototype._start = function () {
        if (this.running) return;
        if (this.totalSeconds === 0) return;
        if (this.expired) this._reset();
        this.running = true;
        this.startBtn.disabled = true;
        this.pauseBtn.disabled = false;
        this._saveRunning();
        var self = this;
        this.interval = setInterval(function () {
          if (self.remaining <= 0) { self._expire(); return; }
          self.remaining--;
          self._saveRunning();
          self._render();
          if (self.remaining <= 0) { self._expire(); }
        }, 1000);
      };

      Timer.prototype._pause = function () {
        if (!this.running) return;
        clearInterval(this.interval);
        this.interval = null;
        this.running  = false;
        this.startBtn.disabled = false;
        this.startBtn.textContent = 'RESUME';
        this.pauseBtn.disabled = true;
        saveState(this.id, { totalSeconds: this.totalSeconds, remaining: this.remaining, running: false, paused: true, startedAt: null });
      };

      Timer.prototype._reset = function () {
        clearInterval(this.interval);
        this.interval = null;
        this.running  = false;
        this.remaining = this.totalSeconds;
        this._clearExpired();
        this.startBtn.disabled = false;
        this.startBtn.textContent = 'START';
        this.pauseBtn.disabled = true;
        saveState(this.id, { totalSeconds: this.totalSeconds, remaining: this.totalSeconds, running: false, paused: false, startedAt: null });
        this._render();
      };

      Timer.prototype._expire = function () {
        clearInterval(this.interval);
        this.interval = null;
        this.running  = false;
        this.expired  = true;
        this.remaining = 0;
        this.startBtn.disabled = true;
        this.pauseBtn.disabled = true;
        saveState(this.id, { totalSeconds: this.totalSeconds, remaining: 0, running: false, paused: false, startedAt: null });
        // Stamp the expired style from the current theme before adding .expired class
        var curTheme = THEMES.find(function (t) { return t.id === currentThemeId; }) || THEMES[0];
        var expStyle = (curTheme.effects && curTheme.effects.expiredStyle) ? curTheme.effects.expiredStyle : 'flash';
        this.panel.setAttribute('data-expired-style', expStyle);
        this.panel.classList.add('expired');
        this.track.classList.remove('low', 'critical');
        this.track.classList.add('expired');
        playAlarm();
        speak(announcementTemplate.replace(/\{\{name\}\}/g, this.displayName));
        this.expiredMsg.classList.add('visible');
        var self = this;
        this.expiredFlatTimeoutId = setTimeout(function () {
          self.panel.classList.add('expired-flat');
          self.expiredFlatTimeoutId = null;
        }, 30000);
        this._render();
      };

      Timer.prototype._clearExpired = function () {
        this.expired = false;
        if (this.expiredFlatTimeoutId !== null) {
          clearTimeout(this.expiredFlatTimeoutId);
          this.expiredFlatTimeoutId = null;
        }
        this.panel.classList.remove('expired', 'expired-flat');
        this.expiredMsg.classList.remove('visible');
        this.track.classList.remove('low', 'critical', 'expired');
        // Restore themed accent styles after clearing expired
        var theme = THEMES.find(function (t) { return t.id === currentThemeId; }) || THEMES[0];
        var accentIdx = parseInt(this.panel.getAttribute('data-accent'), 10) || 0;
        applyAccentToPanel(this.panel, accentIdx, theme);
      };

      Timer.prototype.destroy = function () {
        clearInterval(this.interval);
        this.interval = null;
        if (this.expiredFlatTimeoutId !== null) {
          clearTimeout(this.expiredFlatTimeoutId);
          this.expiredFlatTimeoutId = null;
        }
      };

      Timer.prototype._render = function () {
        var secs = this.remaining;
        var h  = Math.floor(secs / 3600);
        var m  = Math.floor((secs % 3600) / 60);
        var s  = secs % 60;
        var mm = String(m).padStart(2, '0');
        var ss = String(s).padStart(2, '0');
        this.display.textContent = h > 0 ? (h + ':' + mm + ':' + ss) : (mm + ':' + ss);
        var fraction = this.totalSeconds > 0 ? secs / this.totalSeconds : 1;
        this.track.style.strokeDashoffset = CIRCUMFERENCE * (1 - fraction);
        if (!this.expired) {
          if (fraction <= 0.1)       { this.track.classList.remove('low');      this.track.classList.add('critical'); }
          else if (fraction <= 0.25) { this.track.classList.remove('critical'); this.track.classList.add('low'); }
          else                       { this.track.classList.remove('low', 'critical'); }
        }
      };

      /* ── Add timer ───────────────────────────────────────────── */
      function addTimer() {
        var id          = 't' + Date.now();
        var num         = timerList.length + 1;
        var displayName = 'Timer ' + num;
        timerList.push({ id: id, displayName: displayName });
        saveTimerList(timerList);
        var container = document.getElementById('timers-container');
        var panel     = createTimerPanel(id, displayName);
        container.appendChild(panel);
        var timer = new Timer(id, displayName);
        timersById[id] = timer;
        // Apply current theme accent to the new panel
        var theme = THEMES.find(function (t) { return t.id === currentThemeId; }) || THEMES[0];
        var accentIdx = (timerList.length - 1) % NUM_ACCENTS;
        applyAccentToPanel(panel, accentIdx, theme);
        refreshCloseBtns();
        resizeSVGs();
        timer._openNameEdit();
      }

      /* ── Remove timer (with confirmation) ────────────────────── */
      var pendingRemoveId = null;

      function openConfirm(id) {
        if (timerList.length <= 1) return;
        pendingRemoveId = id;
        var entry = timerList.find(function (t) { return t.id === id; });
        document.getElementById('confirm-name').textContent = entry ? entry.displayName.toUpperCase() : id;
        document.getElementById('confirm-overlay').classList.add('visible');
      }

      function closeConfirm() {
        document.getElementById('confirm-overlay').classList.remove('visible');
        pendingRemoveId = null;
      }

      function executeRemove(id) {
        var timer = timersById[id];
        if (timer) { timer.destroy(); delete timersById[id]; }
        try { localStorage.removeItem('mc-timer-' + id); } catch (e) {}
        timerList = timerList.filter(function (t) { return t.id !== id; });
        saveTimerList(timerList);
        var panel = document.getElementById('panel-' + id);
        if (panel) panel.remove();
        refreshCloseBtns();
        reassignAccents();
        resizeSVGs();
      }

      function reassignAccents() {
        var theme = THEMES.find(function (t) { return t.id === currentThemeId; }) || THEMES[0];
        timerList.forEach(function (t, i) {
          var panel = document.getElementById('panel-' + t.id);
          if (panel) {
            panel.setAttribute('data-accent', String(i % NUM_ACCENTS));
            applyAccentToPanel(panel, i, theme);
          }
        });
      }

      /* ── Resize SVGs ─────────────────────────────────────────── */
      function resizeSVGs() {
        document.querySelectorAll('.timer-panel').forEach(function (panel) {
          var svg = panel.querySelector('svg');
          if (!svg) return;

          svg.style.width  = '0';
          svg.style.height = '0';

          var style     = getComputedStyle(panel);
          var padV      = (parseFloat(style.paddingTop)    || 0) + (parseFloat(style.paddingBottom) || 0);
          var padH      = (parseFloat(style.paddingLeft)   || 0) + (parseFloat(style.paddingRight)  || 0);
          var gapSize   = parseFloat(style.gap) || 0;

          var usableH   = panel.clientHeight - padV;
          var usableW   = panel.clientWidth  - padH;

          var fixedH = 0;
          var gaps   = 0;
          panel.children && Array.prototype.forEach.call(panel.children, function (child) {
            if (child === svg.parentElement) return;
            var cs = getComputedStyle(child);
            if (cs.display === 'none' || cs.position === 'absolute') return;
            fixedH += child.offsetHeight;
            gaps   += gapSize;
          });
          gaps += gapSize;

          var available = usableH - fixedH - gaps;
          var size      = Math.min(available, usableW);
          size          = Math.max(size, 110);

          svg.style.width  = size + 'px';
          svg.style.height = size + 'px';
        });
      }

      /* ── Theme picker ────────────────────────────────────────── */
      function renderThemePicker(selectedId) {
        var grid = document.getElementById('theme-picker-grid');
        if (!grid) return;
        grid.innerHTML = '';
        THEMES.forEach(function (theme) {
          var btn = document.createElement('button');
          btn.className = 'theme-btn' + (theme.id === selectedId ? ' selected' : '');
          btn.setAttribute('data-theme-id', theme.id);
          btn.style.background    = theme.previewColors.bg;
          btn.style.color         = theme.previewColors.text;
          btn.style.borderColor   = theme.previewColors.accent;
          btn.textContent         = theme.name;
          btn.addEventListener('click', function () {
            previewThemeId = theme.id;
            applyTheme(theme.id);
            renderThemePicker(theme.id);
          });
          grid.appendChild(btn);
        });
      }

      /* ── Settings dialog ─────────────────────────────────────── */
      var settingsSavedThemeId = 'minecraft';

      function openSettings() {
        settingsSavedThemeId = currentThemeId;
        previewThemeId       = currentThemeId;
        renderThemePicker(currentThemeId);
        document.getElementById('announcement-input').value = announcementTemplate;
        document.getElementById('settings-overlay').classList.add('visible');
        document.getElementById('announcement-input').focus();
      }
      function closeSettings() {
        document.getElementById('settings-overlay').classList.remove('visible');
      }
      function cancelSettings() {
        // Revert to saved theme if user previewed but didn't save
        if (currentThemeId !== settingsSavedThemeId) {
          applyTheme(settingsSavedThemeId);
        }
        closeSettings();
      }
      function saveSettings() {
        var val = document.getElementById('announcement-input').value.trim();
        if (val.length > 0) {
          announcementTemplate = val;
          saveAnnouncement(val);
        }
        // Persist chosen theme
        saveThemeId(currentThemeId);
        settingsSavedThemeId = currentThemeId;
        closeSettings();
      }

      document.getElementById('settings-btn').addEventListener('click', openSettings);
      document.getElementById('settings-cancel').addEventListener('click', cancelSettings);
      document.getElementById('settings-save').addEventListener('click', saveSettings);
      document.getElementById('settings-overlay').addEventListener('click', function (e) {
        if (e.target === this) cancelSettings();
      });

      /* ── Confirm dialog wiring ───────────────────────────────── */
      document.getElementById('add-timer-btn').addEventListener('click', addTimer);

      document.getElementById('confirm-cancel').addEventListener('click', closeConfirm);
      document.getElementById('confirm-overlay').addEventListener('click', function (e) {
        if (e.target === this) closeConfirm();
      });
      document.getElementById('confirm-remove').addEventListener('click', function () {
        if (pendingRemoveId) { executeRemove(pendingRemoveId); }
        closeConfirm();
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          if (document.getElementById('settings-overlay').classList.contains('visible')) {
            cancelSettings();
          } else {
            closeConfirm();
          }
        }
      });

      // Wire up close buttons dynamically (event delegation)
      document.getElementById('timers-container').addEventListener('click', function (e) {
        var btn = e.target.closest('.close-timer-btn');
        if (!btn) return;
        var id = btn.id.replace('close-', '');
        openConfirm(id);
      });

      /* ── Init: load theme, load list, render all panels ──────── */
      currentThemeId = loadThemeId();
      applyTheme(currentThemeId);

      timerList = loadTimerList();
      var container = document.getElementById('timers-container');
      timerList.forEach(function (entry) {
        var panel = createTimerPanel(entry.id, entry.displayName);
        container.appendChild(panel);
        timersById[entry.id] = new Timer(entry.id, entry.displayName);
      });

      // Apply theme accents to freshly rendered panels
      var initTheme = THEMES.find(function (t) { return t.id === currentThemeId; }) || THEMES[0];
      applyAccentsToAllPanels(initTheme);

      refreshCloseBtns();

      window.addEventListener('resize', resizeSVGs);
      resizeSVGs();
    })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('sw.js').catch(function () {});
      });
    }
  </script>
</body>
</html>
